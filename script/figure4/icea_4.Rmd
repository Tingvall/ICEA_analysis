---
title: "ICE-A: Figure 4"
output: html_notebook
---

# 4 Investigation of alternative promoters for EBF1 bound T-lineage associated elements

## 4.0 Preperations
Run before:
conda activate liana_analysis_env
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/anaconda3/envs/liana_analysis_env/lib

Setting working directory
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("../../"))
```

Loading packages
```{r}
packages <- c("readxl", "AnnotationDbi", "org.Mm.eg.db", "clusterProfiler", "ggplot2", "ggpubr", "circlize", "data.table", "DiffBind", "tidyr", "htmltools")
lapply(packages, library, character.only = TRUE)
```

## 4.1 Define T elements
### 4.1.1 Identify T associated peaks
Distal elements annotated to T gene list in P2C2
```{r}
#Load T genes
t.genes <- read.table("output/data/figure2/genelists/Tcell_genes.txt", sep = "\t")

#Load annotaiton of consensus peaks
T_elements_anno_iceaP2C2 <- read.table("output/data/figure2/annotation/atac_230238_p2c2_consensus_peaks_P2C2_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
T_elements_anno_iceaP2C2$peakID <- paste0(T_elements_anno_iceaP2C2$Chr, ":", T_elements_anno_iceaP2C2$Start, "-", T_elements_anno_iceaP2C2$End)
T_elements_anno_iceaP2C2$id <- paste0(T_elements_anno_iceaP2C2$peakID, "_", T_elements_anno_iceaP2C2$Gene)
T_elements_anno_iceaP2C2_distal <- T_elements_anno_iceaP2C2[T_elements_anno_iceaP2C2$Annotation_method=="Interaction_anno" &T_elements_anno_iceaP2C2$Peak_type!="Promoter",]

#Extract T elements: Peak in P2C2 & linked to T gene
BT_elements_info <- read.table("output/data/figure2/peaks/atac_230238_p2c2_idr_consensus_info.bed", header=F, sep="\t")
colnames(BT_elements_info) <- c("chr", "start", "end", "anno")
BT_elements_info$peakID <- paste0(BT_elements_info$chr, ":", BT_elements_info$start, "-", BT_elements_info$end)

#Filter
T_elements_anno_iceaP2C2_distal <- T_elements_anno_iceaP2C2_distal[T_elements_anno_iceaP2C2_distal$Gene %in% t.genes$V1,]
T_elements_anno_iceaP2C2_distal <- T_elements_anno_iceaP2C2_distal[T_elements_anno_iceaP2C2_distal$peakID %in% T_elements_anno_iceaP2C2_distal[T_elements_anno_iceaP2C2_distal$anno!= "230238",]$peakID,]
T_elements_anno_iceaP2C2_distal <- T_elements_anno_iceaP2C2_distal[order(T_elements_anno_iceaP2C2_distal$Interaction_score),]
T_elements_anno_iceaP2C2_distal <- T_elements_anno_iceaP2C2_distal[!duplicated(T_elements_anno_iceaP2C2_distal$id),]

write.table(T_elements_anno_iceaP2C2_distal[,1:3], "output/data/figure4/T_elements_anno_iceaP2C2_distal.bed", quote = F, sep = "\t", row.names = F, col.names = F)
```


### 4.1.2 T element in B cells
Annotate consensus peaks set with EKO/WT PLACseq data. Annotate interaction option for 4.5 (longrange track generation)
```{bash engine.opts='-l'}
script_dir="script/figure4"
bash $script_dir/liana_consensus_230238_p2c2_atac_WT_EKO_annotate_interactions.sh
```

Investigate if T elements linked to T genes in WT/EKO 
```{r}
#Duw to technical issues, total nuber of sign interaction much higher in EKO => Use top 100k interactions (based on q-value). FIns q-value cutoff
int.wt <-  read.table("data/plac/21_174_175_H3K4me3_FLWT_5kb_ALL2ALL.interactions_FitHiC_Q0.05_MergeNearContacts.bed", header=TRUE, sep="\t")
int.wt <- int.wt[order(int.wt$Q.Value_Bias),]
int.wt.top <- int.wt[1:100000,]
int.wt.cutoff <- -log10(max(int.wt.top$Q.Value_Bias))

int.eko <-  read.table("data/plac/13_16_176_177_H3K4me3_FLEKO_5kb_ALL2ALL.interactions_FitHiC_Q0.05_MergeNearContacts.bed", header=TRUE, sep="\t")
int.eko <- int.eko[order(int.eko$Q.Value_Bias),]
int.eko.top <- int.eko[1:100000,]
int.eko.cutoff <- -log10(max(int.eko.top$Q.Value_Bias))

#Load annotaiton of consensus peaks
BT_elements_anno_lianaWT <- read.table("output/data/data_5/annotation/Consensus_atac_WTproB_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
BT_elements_anno_lianaWT$peakID <- paste0(BT_elements_anno_lianaWT$Chr, ":", BT_elements_anno_lianaWT$Start, "-", BT_elements_anno_lianaWT$End)
BT_elements_anno_lianaWT$id <- paste0(BT_elements_anno_lianaWT$peakID, "_", BT_elements_anno_lianaWT$Gene)
BT_elements_anno_lianaWT_distal <- BT_elements_anno_lianaWT[BT_elements_anno_lianaWT$Annotation_method=="Interaction_anno" &BT_elements_anno_lianaWT$Peak_type!="Promoter",]
BT_elements_anno_lianaWT_distal <- BT_elements_anno_lianaWT_distal[BT_elements_anno_lianaWT_distal$Interaction_score<max(int.wt.top$Q.Value_Bias),]

BT_elements_anno_lianaEKO <- read.table("output/data/data_5/annotation/Consensus_atac_Ebf1KOproB_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
BT_elements_anno_lianaEKO$peakID <- paste0(BT_elements_anno_lianaEKO$Chr, ":", BT_elements_anno_lianaEKO$Start, "-", BT_elements_anno_lianaEKO$End)
BT_elements_anno_lianaEKO$id <- paste0(BT_elements_anno_lianaEKO$peakID, "_", BT_elements_anno_lianaEKO$Gene)
BT_elements_anno_lianaEKO_distal <- BT_elements_anno_lianaEKO[BT_elements_anno_lianaEKO$Annotation_method=="Interaction_anno" &BT_elements_anno_lianaEKO$Peak_type!="Promoter",]
BT_elements_anno_lianaEKO_distal <- BT_elements_anno_lianaEKO_distal[BT_elements_anno_lianaEKO_distal$Interaction_score<max(int.eko.top$Q.Value_Bias),]
```

Merge
```{r}

T.pseudo <- T_elements_anno_lianaP2C2_distal[,c(18, 17, 1:3, 6,9,5)]
#T.pseudo <- BT_elements_anno_lianaEKO_distal[,c(18, 17, 1:3, 6,9,5)]

T.pseudo$Tgene_p2c2 <- "tgene"
T.pseudo$Tgene_WT<- ifelse(T.pseudo$id %in% BT_elements_anno_lianaWT_distal$id, "tgene", "NA")
T.pseudo$Tgene_EKO<- ifelse(T.pseudo$id %in% BT_elements_anno_lianaEKO_distal$id, "tgene", "NA")
```



## 5.2 Alternative tss

### 5.2.1 Define promoters & pseudopromoters

For annotation to pseudopromters, custom tss locations are required. All potential promoters/pseudopromoters regions defines as ATAC-seq peaks overlapping H3K4me3 & PolII in WT
```{bash engine.opts='-l'}
bash script/general/bedtools_intersect_wa.sh data/atac/peaks/ATAC_FLproB_WT_idr_optimal_peak.narrowPeak data/chip_cnr/peaks/H3K4me3_WT_optimal_set.IDR0.05.narrowPeak output/data/data_5/overlap/WT_atac_H3K4me3_overlap.bed

bash script/general/bedtools_intersect_wa.sh output/data/data_5/overlap/WT_atac_H3K4me3_overlap.bed data/chip_cnr/peaks/Rpb_ser2_optimal_set.IDR0.05.narrowPeak output/data/data_5/overlap/WT_atac_H3K4me3_polII_overlap.bed
```

Organize defined promoters regions to be compatible with custom TSS input in liana
```{r}
#Load custom promoter regions
custom.promoters <- read.table("output/data/data_5/overlap/WT_atac_H3K4me3_overlap.bed", header=F, sep="\t", quote = "")
custom.promoters <- custom.promoters[,1:3]
colnames(custom.promoters) <- c("chr", "start", "end")
custom.promoters$peakID <- paste0(custom.promoters$chr, ":",custom.promoters$start, "-", custom.promoters$end)
custom.promoters <- custom.promoters[!duplicated(custom.promoters),]

#Writing custom tss.txt file for liana annotation
custom.promoters <- custom.promoters[,c(4,1:3)]
custom.promoters$strand=0
write.table(custom.promoters, "output/data/data_5/annotation/custom_tss.txt", quote = F, sep = "\t", row.names = F, col.names = F)
```

### 5.2.2 Custom annotation with defined alternative promoters

```{bash engine.opts='-l'}
script_dir="script/analysis_5"
bash $script_dir/liana_consensus_atac_P2C2_WT_EKO_custom_tss.sh
```

### 5.2.3 Alternative annotation
```{r}
#Load annotaiton of consensus peaks
tss_anno_lianaP2C2 <- read.table("output/data/data_5/annotation/Consensus_atac_P2C2_H3K4me3_PLAC_annotation_custom_TSS/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
tss_anno_lianaP2C2$peakID <- paste0(tss_anno_lianaP2C2$Chr, ":", tss_anno_lianaP2C2$Start, "-", tss_anno_lianaP2C2$End)
tss_anno_lianaP2C2$id <- paste0(tss_anno_lianaP2C2$peakID, "_", tss_anno_lianaP2C2$Gene)
tss_anno_lianaP2C2_distal <- tss_anno_lianaP2C2[tss_anno_lianaP2C2$Annotation_method=="Interaction_anno" &tss_anno_lianaP2C2$Peak_type!="Promoter",]

tss_anno_lianaWT <- read.table("output/data/data_5/annotation/Consensus_atac_WTproB_H3K4me3_PLAC_annotation_custom_TSS/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
tss_anno_lianaWT$peakID <- paste0(tss_anno_lianaWT$Chr, ":", tss_anno_lianaWT$Start, "-", tss_anno_lianaWT$End)
tss_anno_lianaWT$id <- paste0(tss_anno_lianaWT$peakID, "_", tss_anno_lianaWT$Gene)
tss_anno_lianaWT_distal <- tss_anno_lianaWT[tss_anno_lianaWT$Annotation_method=="Interaction_anno" &tss_anno_lianaWT$Peak_type!="Promoter",]
tss_anno_lianaWT_distal <- tss_anno_lianaWT_distal[tss_anno_lianaWT_distal$Interaction_score<max(int.wt.top$Q.Value_Bias),]


tss_anno_lianaEKO <- read.table("output/data/data_5/annotation/Consensus_atac_Ebf1KOproB_H3K4me3_PLAC_annotation_custom_TSS/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
tss_anno_lianaEKO$peakID <- paste0(tss_anno_lianaEKO$Chr, ":", tss_anno_lianaEKO$Start, "-", tss_anno_lianaEKO$End)
tss_anno_lianaEKO$id <- paste0(tss_anno_lianaEKO$peakID, "_", tss_anno_lianaEKO$Gene)
tss_anno_lianaEKO_distal <- tss_anno_lianaEKO[tss_anno_lianaEKO$Annotation_method=="Interaction_anno" &tss_anno_lianaEKO$Peak_type!="Promoter",]
tss_anno_lianaEKO_distal <- tss_anno_lianaEKO_distal[tss_anno_lianaEKO_distal$Interaction_score<max(int.eko.top$Q.Value_Bias),]
```

Annotate custom TSS (to  define real/pseudopromoters)
```{bash engine.opts='-l'}
cd output/data/data_5/annotation
cut -f2-4 custom_tss.txt > custom_tss.bed
annotatePeaks.pl custom_tss.bed mm10 > custom_tss_homer_annotation.txt
awk -v FS='\t' -v OFS='\t' '{print $2, $3, $4, $16, $10}' custom_tss_homer_annotation.txt > custom_tss_homer_annotation_cut.txt
```

```{r}
custom_tss_anno <- read.table("output/data/data_5/annotation/custom_tss_homer_annotation_cut.txt", header=T, sep="\t")
custom_tss_anno$Start <- custom_tss_anno$Start-1
custom_tss_anno$peakID <- paste0(custom_tss_anno$Chr, ":", custom_tss_anno$Start, "-", custom_tss_anno$End)
custom_tss_anno$promoter <- ifelse(abs(custom_tss_anno$Distance.to.TSS)<= 1000,1,0)
write.table(custom_tss_anno[custom_tss_anno$promoter==1,1:3], "output/data/data_5/annotation/custom_tss_promoters.bed", quote = F, sep = "\t", row.names = F, col.names = F)
write.table(custom_tss_anno[custom_tss_anno$promoter==0,1:3], "output/data/data_5/annotation/custom_tss_pseudopromoters.bed", quote = F, sep = "\t", row.names = F, col.names = F)
```

Overlap with Ebf1 biding in alternative tss
```{bash engine.opts='-l'}
bash script/general/bedtools_intersect_wa.sh output/data/data_5/annotation/custom_tss.bed data/chip_cnr/peaks/GSE159957_230_238_a_Ebf1_IDR-peaks.bed output/data/data_5/annotation/custom_tss_Ebf1_overlap.bed
```

```{r}
custom_tss_ebf1 <- read.table("output/data/data_5/annotation/custom_tss_Ebf1_overlap.bed", header=F, sep="\t")
colnames(custom_tss_ebf1) <- c("chr", "start", "end")
custom_tss_ebf1$peakID <- paste0(custom_tss_ebf1$chr, ":", custom_tss_ebf1$start, "-", custom_tss_ebf1$end)
```

Merge
```{r}
# Alterantive tss (based on WT annotation)
tss.alt <- tss_anno_lianaWT_distal[,c(18,17,1:3, 9,5, 14)]
tss.alt <- tss.alt[tss.alt$peakID %in% T.pseudo$peakID,]
tss.alt <- tss.alt[order(tss.alt$Interaction_score),]
tss.alt <- tss.alt[!duplicated(tss.alt),]

#Add info about real/pseudo-promoter
T.pseudo <- merge(T.pseudo, tss.alt[,c(2,1,3:5,6, 7)], by="peakID", all.x=T)
T.pseudo$promoter <- ifelse(T.pseudo$Gene.y %in% custom_tss_anno[custom_tss_anno$promoter==1,]$peakID, "Promoter",ifelse(T.pseudo$Gene.y %in% custom_tss_anno[custom_tss_anno$promoter==0,]$peakID, "Pseudo","NA")) 
T.pseudo$ebf1 <- ifelse(T.pseudo$Gene.y %in% custom_tss_ebf1$peakID, "Ebf1","NA") 

#Add info about interaction in celltypes
T.pseudo$tss_p2c2 <- ifelse(T.pseudo$id.y %in% tss_anno_lianaP2C2_distal$id, "alt", "NA")
T.pseudo$tss_WT<- ifelse(T.pseudo$id.y %in% tss_anno_lianaWT_distal$id, "alt", "NA")
T.pseudo$tss_EKO <- ifelse(T.pseudo$id.y %in% tss_anno_lianaEKO_distal$id,"alt", "NA")

T.pseudo.tilt <- T.pseudo[T.pseudo$promoter!="NA" & T.pseudo$ebf1=="Ebf1" & T.pseudo$tss_p2c2=="NA" & T.pseudo$tss_EKO=="NA" & T.pseudo$Tgene_WT=="NA",]
T.pseudo.tilt <- T.pseudo.tilt[!duplicated(T.pseudo.tilt),]


```

## 5.3 Circos plot

### 5.3.1 Filter and organize input

Filter
```{r}
#Pseudo
#T.pseudo.f <- T.pseudo[T.pseudo$promoter=="Pseudo",]
T.pseudo.f <- T.pseudo
T.pseudo.f$Chr.x <- factor(gsub("chr","",T.pseudo.f$Chr.x), levels = c(1:19, "X", "Y")) 
T.pseudo.f$Chr.y <- factor(gsub("chr","",T.pseudo.f$Chr.y), levels = c(1:19, "X", "Y"))   
T.pseudo.f <- T.pseudo.f[order(T.pseudo.f$Chr.y, T.pseudo.f$Start.y),]

#Promoter
#T.pseudo.e <- T.pseudo[T.pseudo$ebf1=="Ebf1",]
T.pseudo.e <- T.pseudo
T.pseudo.e$Chr.x <- factor(gsub("chr","",T.pseudo.e$Chr.x), levels = c(1:19, "X", "Y")) 
T.pseudo.e$Chr.y <- factor(gsub("chr","",T.pseudo.e$Chr.y), levels = c(1:19, "X", "Y"))   
T.pseudo.e <- T.pseudo.e[order(T.pseudo.e$Chr.y, T.pseudo.e$Start.y),]
```



Organize input for circus plot - Pseudo only (Not used)
```{r}
#T.pseudo.f <- T.pseudo.f[order(T.pseudo.f$tss_WT, T.pseudo.f$ebf1),]
test.p <- data.frame(section="T_enh", name=unique(T.pseudo.f[order(T.pseudo.f$Chr.x, T.pseudo.f$Start.x),]$peakID))
test.t <- data.frame(section="T_gene", name=unique(T.pseudo.f[order(T.pseudo.f$Gene.x),]$Gene.x))
test.a <- data.frame(section="Alt", name=unique(T.pseudo.f[!is.na(T.pseudo.f$Gene.y) & T.pseudo.f$ebf1=="NA" & T.pseudo.f$promoter=="Pseudo",]$Gene.y))
test.e <- data.frame(section="Alt_Ebf1", name=unique(T.pseudo.f[!is.na(T.pseudo.f$Gene.y) & T.pseudo.f$ebf1=="Ebf1" &T.pseudo.f$promoter=="Pseudo",]$Gene.y))

test <- rbind(test.p,test.t, test.a, test.e)
test$x <- 1:nrow(test)
test$section <- factor(test$section, levels=c("T_enh", "T_gene", "Alt", "Alt_Ebf1"))

#Scaling
test$x <- ifelse(test$section!="T_enh", test$x*2,test$x)
cols <- c("#59595b","#274267", "#632a54", "#799f55")

#"#799f55"
#p2c2
links.p2c2 <- na.omit(rbind(data.frame(from=T.pseudo.f[T.pseudo.f$Tgene_p2c2=="tgene",]$peakID, to=T.pseudo.f[T.pseudo.f$Tgene_p2c2=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="NA" & T.pseudo.f$tss_p2c2=="alt" & T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="NA" &  T.pseudo.f$tss_p2c2=="alt" &T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" & T.pseudo.f$tss_p2c2=="alt"&T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" &  T.pseudo.f$tss_p2c2=="alt" &T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt_Ebf1")))
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="from", by.y="name")
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="to", by.y="name")
links.p2c2 <- links.p2c2[,c(2,1,3,4,5)]
colnames(links.p2c2) <- c("from", "to", "section","x1", "x2")
links.p2c2 <- links.p2c2[!duplicated(links.p2c2),]
links.p2c2$col <- ifelse(links.p2c2$section=="Alt_Ebf1", cols[4], ifelse(links.p2c2$section=="Alt", cols[3], cols[2]))
links.p2c2$section <- factor(links.p2c2$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.p2c2 <- links.p2c2[order(links.p2c2$section),]

#wt
links.WT <- na.omit(rbind(data.frame(from=T.pseudo.f[T.pseudo.f$Tgene_WT=="tgene",]$peakID, to=T.pseudo.f[T.pseudo.f$Tgene_WT=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="NA" & T.pseudo.f$tss_WT=="alt"&T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="NA" &  T.pseudo.f$tss_WT=="alt"&T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" & T.pseudo.f$tss_WT=="alt"&T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" &  T.pseudo.f$tss_WT=="alt"&T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt_Ebf1")))
links.WT <- merge(links.WT, test[,2:3], by.x="from", by.y="name")
links.WT <- merge(links.WT, test[,2:3], by.x="to", by.y="name")
links.WT <- links.WT[,c(2,1,3,4,5)]
colnames(links.WT) <- c("from", "to", "section","x1", "x2")
links.WT <- links.WT[!duplicated(links.WT),]
links.WT$col <- ifelse(links.WT$section=="Alt_Ebf1", cols[4], ifelse(links.WT$section=="Alt", cols[3], cols[2]))
links.WT$section <- factor(links.WT$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.WT <- links.WT[order(links.WT$section),]


#eko
links.EKO <- na.omit(rbind(data.frame(from=T.pseudo.f[T.pseudo.f$Tgene_EKO=="tgene",]$peakID, to=T.pseudo.f[T.pseudo.f$Tgene_EKO=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="NA" & T.pseudo.f$tss_EKO=="alt"&T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="NA" &  T.pseudo.f$tss_EKO=="alt"&T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" & T.pseudo.f$tss_EKO=="alt"&T.pseudo.f$promoter=="Pseudo",]$peakID, to=T.pseudo.f[T.pseudo.f$ebf1=="Ebf1" &  T.pseudo.f$tss_EKO=="alt"&T.pseudo.f$promoter=="Pseudo",]$Gene.y, section="Alt_Ebf1")))
links.EKO <- merge(links.EKO, test[,2:3], by.x="from", by.y="name")
links.EKO <- merge(links.EKO, test[,2:3], by.x="to", by.y="name")
links.EKO <- links.EKO[,c(2,1,3,4,5)]
colnames(links.EKO) <- c("from", "to", "section","x1", "x2")
links.EKO <- links.EKO[!duplicated(links.EKO),]
links.EKO$col <- ifelse(links.EKO$section=="Alt_Ebf1", cols[4], ifelse(links.EKO$section=="Alt", cols[3], cols[2]))
links.EKO$section <- factor(links.EKO$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.EKO <- links.EKO[order(links.EKO$section),]


##plot
test.sum <- aggregate(test$x, list(test$section), FUN=mean) 
test.sum$x.adj <- max(test$x)-test.sum$x+max(test$x)/360*30

layout(matrix(1:3, 1, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
#p2c2
circos.clear()
circos.par("track.height" = 0.1, "clock.wise"=F, start.degree=19, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.p2c2)){
  circos.link("T_enh", links.p2c2[i,"x1"], links.p2c2[i,"section"], links.p2c2[i,"x2"], lwd=0.25,col = links.p2c2[i,"col"])
}
#Wt
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=19, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.WT)){
  circos.link("T_enh", links.WT[i,"x1"], links.WT[i,"section"], links.WT[i,"x2"], lwd=0.25,  col = links.WT[i,"col"])
}
#eko
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=19, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.EKO)){
  circos.link("T_enh", links.EKO[i,"x1"], links.EKO[i,"section"], links.EKO[i,"x2"], lwd=0.25, col = links.EKO[i,"col"])
}

```

Organize input for circus plot - ebf only (Used in figure)
```{r}
#T.pseudo.f <- T.pseudo.f[order(T.pseudo.f$tss_WT, T.pseudo.f$ebf1),]
test.p <- data.frame(section="T_enh", name=unique(T.pseudo.e[order(T.pseudo.e$Chr.x, T.pseudo.e$Start.x),]$peakID))
test.t <- data.frame(section="T_gene", name=unique(T.pseudo.e[order(T.pseudo.e$Gene.x),]$Gene.x))
test.a <- data.frame(section="Alt", name=unique(T.pseudo.e[!is.na(T.pseudo.e$Gene.y) & T.pseudo.e$promoter=="Promoter" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y))
test.e <- data.frame(section="Alt_Ebf1", name=unique(T.pseudo.e[!is.na(T.pseudo.e$Gene.y) & T.pseudo.e$promoter=="Pseudo"& T.pseudo.e$ebf1=="Ebf1",]$Gene.y))

test <- rbind(test.p,test.t, test.a, test.e)
test$x <- 1:nrow(test)
test$section <- factor(test$section, levels=c("T_enh", "T_gene", "Alt", "Alt_Ebf1"))

#Scaling
test$x <- ifelse(test$section!="T_enh", test$x*2,test$x)

#"#799f55"
#p2c2
links.p2c2 <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_p2c2=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_p2c2=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_p2c2=="alt" & T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter" &  T.pseudo.e$tss_p2c2=="alt" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_p2c2=="alt" &T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_p2c2=="alt" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt_Ebf1")))
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="from", by.y="name")
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="to", by.y="name")
links.p2c2 <- links.p2c2[,c(2,1,3,4,5)]
colnames(links.p2c2) <- c("from", "to", "section","x1", "x2")
links.p2c2 <- links.p2c2[!duplicated(links.p2c2),]
links.p2c2$col <- ifelse(links.p2c2$section=="Alt_Ebf1", cols[4], ifelse(links.p2c2$section=="Alt", cols[3], cols[2]))
links.p2c2$section <- factor(links.p2c2$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.p2c2 <- links.p2c2[order(links.p2c2$section),]

#wt
links.WT <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_WT=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_WT=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_WT=="alt" &T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter"&  T.pseudo.e$tss_WT=="alt" &T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_WT=="alt" & T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_WT=="alt" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt_Ebf1")))
links.WT <- merge(links.WT, test[,2:3], by.x="from", by.y="name")
links.WT <- merge(links.WT, test[,2:3], by.x="to", by.y="name")
links.WT <- links.WT[,c(2,1,3,4,5)]
colnames(links.WT) <- c("from", "to", "section","x1", "x2")
links.WT <- links.WT[!duplicated(links.WT),]
links.WT$col <- ifelse(links.WT$section=="Alt_Ebf1", cols[4], ifelse(links.WT$section=="Alt", cols[3], cols[2]))
links.WT$section <- factor(links.WT$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.WT <- links.WT[order(links.WT$section),]


#eko
links.EKO <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_EKO=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_EKO=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_EKO=="alt" &T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter" &  T.pseudo.e$tss_EKO=="alt" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_EKO=="alt" & T.pseudo.e$ebf1=="Ebf1",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_EKO=="alt" & T.pseudo.e$ebf1=="Ebf1",]$Gene.y, section="Alt_Ebf1")))
links.EKO <- merge(links.EKO, test[,2:3], by.x="from", by.y="name")
links.EKO <- merge(links.EKO, test[,2:3], by.x="to", by.y="name")
links.EKO <- links.EKO[,c(2,1,3,4,5)]
colnames(links.EKO) <- c("from", "to", "section","x1", "x2")
links.EKO <- links.EKO[!duplicated(links.EKO),]
links.EKO$col <- ifelse(links.EKO$section=="Alt_Ebf1", cols[4], ifelse(links.EKO$section=="Alt", cols[3], cols[2]))
links.EKO$section <- factor(links.EKO$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.EKO <- links.EKO[order(links.EKO$section),]


##plot
cols <- c("#59595b","#274267", "#632a54", "#799f55")
test.sum <- aggregate(test$x, list(test$section), FUN=mean) 
test.sum$x.adj <- max(test$x)-test.sum$x+max(test$x)/360*30

cairo_pdf("output/plots/plots_5/Tgene_alternative_promoters_circos.pdf", width = 12, height=6)
layout(matrix(1:3, 1, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
#p2c2
circos.clear()
circos.par("track.height" = 0.1, "clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.p2c2)){
  circos.link("T_enh", links.p2c2[i,"x1"], links.p2c2[i,"section"], links.p2c2[i,"x2"], lwd=0.2,col = links.p2c2[i,"col"])
}
#Wt
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.WT)){
  circos.link("T_enh", links.WT[i,"x1"], links.WT[i,"section"], links.WT[i,"x2"], lwd=0.2,  col = links.WT[i,"col"])
}
#eko
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.EKO)){
  circos.link("T_enh", links.EKO[i,"x1"], links.EKO[i,"section"], links.EKO[i,"x2"], lwd=0.2, col = links.EKO[i,"col"])
}
dev.off()

length(links.p2c2[links.p2c2$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100

```

Organize input for circus plot - all (Not used)
```{r}
#T.pseudo.f <- T.pseudo.f[order(T.pseudo.f$tss_WT, T.pseudo.f$ebf1),]
test.p <- data.frame(section="T_enh", name=unique(T.pseudo.e[order(T.pseudo.e$Chr.x, T.pseudo.e$Start.x),]$peakID))
test.t <- data.frame(section="T_gene", name=unique(T.pseudo.e[order(T.pseudo.e$Gene.x),]$Gene.x))
test.a <- data.frame(section="Alt", name=unique(T.pseudo.e[!is.na(T.pseudo.e$Gene.y) & T.pseudo.e$promoter=="Promoter",]$Gene.y))
test.e <- data.frame(section="Alt_Ebf1", name=unique(T.pseudo.e[!is.na(T.pseudo.e$Gene.y) & T.pseudo.e$promoter=="Pseudo",]$Gene.y))

test <- rbind(test.p,test.t, test.a, test.e)
test$x <- 1:nrow(test)
test$section <- factor(test$section, levels=c("T_enh", "T_gene", "Alt", "Alt_Ebf1"))

#Scaling
test$x <- ifelse(test$section!="T_enh", test$x*2,test$x)

#"#799f55"
#p2c2
links.p2c2 <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_p2c2=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_p2c2=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_p2c2=="alt",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter" &  T.pseudo.e$tss_p2c2=="alt",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_p2c2=="alt",]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_p2c2=="alt",]$Gene.y, section="Alt_Ebf1")))
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="from", by.y="name")
links.p2c2 <- merge(links.p2c2, test[,2:3], by.x="to", by.y="name")
links.p2c2 <- links.p2c2[,c(2,1,3,4,5)]
colnames(links.p2c2) <- c("from", "to", "section","x1", "x2")
links.p2c2 <- links.p2c2[!duplicated(links.p2c2),]
links.p2c2$col <- ifelse(links.p2c2$section=="Alt_Ebf1", cols[4], ifelse(links.p2c2$section=="Alt", cols[3], cols[2]))
links.p2c2$section <- factor(links.p2c2$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.p2c2 <- links.p2c2[order(links.p2c2$section),]

#wt
links.WT <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_WT=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_WT=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_WT=="alt" ,]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter"&  T.pseudo.e$tss_WT=="alt" ,]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_WT=="alt" ,]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_WT=="alt",]$Gene.y, section="Alt_Ebf1")))
links.WT <- merge(links.WT, test[,2:3], by.x="from", by.y="name")
links.WT <- merge(links.WT, test[,2:3], by.x="to", by.y="name")
links.WT <- links.WT[,c(2,1,3,4,5)]
colnames(links.WT) <- c("from", "to", "section","x1", "x2")
links.WT <- links.WT[!duplicated(links.WT),]
links.WT$col <- ifelse(links.WT$section=="Alt_Ebf1", cols[4], ifelse(links.WT$section=="Alt", cols[3], cols[2]))
links.WT$section <- factor(links.WT$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.WT <- links.WT[order(links.WT$section),]


#eko
links.EKO <- na.omit(rbind(data.frame(from=T.pseudo.e[T.pseudo.e$Tgene_EKO=="tgene",]$peakID, to=T.pseudo.e[T.pseudo.e$Tgene_EKO=="tgene",]$Gene.x, section="T_gene"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Promoter" & T.pseudo.e$tss_EKO=="alt" ,]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Promoter" &  T.pseudo.e$tss_EKO=="alt",]$Gene.y, section="Alt"), data.frame(from=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" & T.pseudo.e$tss_EKO=="alt" ,]$peakID, to=T.pseudo.e[T.pseudo.e$promoter=="Pseudo" &  T.pseudo.e$tss_EKO=="alt" ,]$Gene.y, section="Alt_Ebf1")))
links.EKO <- merge(links.EKO, test[,2:3], by.x="from", by.y="name")
links.EKO <- merge(links.EKO, test[,2:3], by.x="to", by.y="name")
links.EKO <- links.EKO[,c(2,1,3,4,5)]
colnames(links.EKO) <- c("from", "to", "section","x1", "x2")
links.EKO <- links.EKO[!duplicated(links.EKO),]
links.EKO$col <- ifelse(links.EKO$section=="Alt_Ebf1", cols[4], ifelse(links.EKO$section=="Alt", cols[3], cols[2]))
links.EKO$section <- factor(links.EKO$section, levels=c("T_gene", "Alt", "Alt_Ebf1"))
links.EKO <- links.EKO[order(links.EKO$section),]


##plot
cols <- c("#59595b","#274267", "#632a54", "#799f55")
test.sum <- aggregate(test$x, list(test$section), FUN=mean) 
test.sum$x.adj <- max(test$x)-test.sum$x+max(test$x)/360*30

cairo_pdf("output/plots/plots_5/Tgene_alternative_promoters_circos_all.pdf", width = 12, height=6)
layout(matrix(1:3, 1, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
#p2c2
circos.clear()
circos.par("track.height" = 0.1, "clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.p2c2)){
  circos.link("T_enh", links.p2c2[i,"x1"], links.p2c2[i,"section"], links.p2c2[i,"x2"], lwd=0.2,col = links.p2c2[i,"col"])
}
#Wt
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.WT)){
  circos.link("T_enh", links.WT[i,"x1"], links.WT[i,"section"], links.WT[i,"x2"], lwd=0.2,  col = links.WT[i,"col"])
}
#eko
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=26.5, gap.degree=c(30, 5,5,30))
circos.initialize(test$section, x = test$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.EKO)){
  circos.link("T_enh", links.EKO[i,"x1"], links.EKO[i,"section"], links.EKO[i,"x2"], lwd=0.2, col = links.EKO[i,"col"])
}
dev.off()

length(links.p2c2[links.p2c2$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="T_gene",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="Alt",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="Alt_Ebf1",]$from)#/length(unique(links.p2c2$from))*100

```


## 5.4 Changes in gene expression at T genes in EKOvsWT
```{r}
#Organize data for violin plot
T.int <- T.pseudo.e[T.pseudo.e$Tgene_EKO=="tgene",c(1,7,8,10,16,17,18,19,21,22)]
T.int$alt <- ifelse(!is.na(T.int$Gene.y) & T.int$ebf1=="Ebf1", "Alt_Ebf1", ifelse(!is.na(T.int$Gene.y) & T.int$ebf1!="Ebf1", "Alt", "No_alt"))
T.int$group1 <- ifelse(T.int$Tgene_WT=="tgene", "Common", "EKO_only")
T.int$group2 <- ifelse(T.int$tss_EKO=="alt", "Common", "WT_only")
T.int.f <- T.int[T.int$alt =="Alt_Ebf1",]
T.int.f <- merge(T.int.f, rna.norm.WT.EKO[,c(3,10:12)], by.x="Gene.x", by.y="symbol")

T.int.f2 <- T.int.f[,c(1,12,13,14,15,16)]
T.int.f2 <- T.int.f2[!duplicated(T.int.f2),]
T.int.f2.w <- gather(T.int.f2, celltype, value, WT_mean:EKO_mean, factor_key=TRUE)
T.int.f2.w$celltype <- factor(T.int.f2.w$celltype, levels=c("EKO_mean", "WT_mean"))

#plot
source("script/functions/TG_theme.R")
my_comparisons <- list( c("WT_mean", "EKO_mean"))
plot.Tgenes.alt<- ggplot(T.int.f2.w, aes(celltype, log2(value+1)))+
  geom_violin()+ geom_boxplot(width=0.1, outlier.alpha = 0)+
  theme_bw() +
   facet_grid(group2  ~ group1)+
  ylim(0,17)+
  TG_theme()+
stat_compare_means(comparisons = my_comparisons, label="p.signif", label.y = c(14))

ggsave(path="output/plots/plots_5", filename="EKOvsWT_Tgenes_alternative_prom_violin.pdf", plot = plot.Tgenes.alt, device = "pdf", dpi=300, height=8, width=5)
#Violin plot of T genes with EKO interaction to T element, associated with Ebf1 bound alternative promoter (real or pseduo) in WT. log2 norm gene expression of WT/EKO.
```


#Histone/PolII in pseudo
```{r}
###Select elemetns
Tpol2 <- T.pseudo[T.pseudo$tss_WT=="alt",]
Tpol2 <- Tpol2[,c(13:19, 20,22, 1,7,8,10,11)]

###Data processing
#Loading sample info
samples.cnr.230238.p2c2.histones_polII <- rbind(read.table("data/atac/info/samples_atac_230238_p2c2_atac.txt", header=TRUE, sep="\t", quote = ""),read.table("data/chip_cnr/info/samples_cnr_230238_p2c2_histones_polII.txt", header=TRUE, sep="\t", quote = ""))

#Extracting normalized coutns in GSE201141 atac-seq peaks
dbo.cnr.230238.p2c2.histones.polII <- dba(sampleSheet=samples.cnr.230238.p2c2.histones_polII)
counts.cnr.230238.p2c2.histones.polII <- dba.count(dbo.cnr.230238.p2c2.histones.polII, peaks="output/data/data_5/overlap/WT_atac_H3K4me3_overlap_cut.bed", summits = F)
save(counts.cnr.230238.p2c2.histones.polII, file="output/data/data_5/rdata/counts.cnr.230238.p2c2.histones.polII_alternative_promoters.Rdata")
load( file="output/data/data_5/rdata/counts.cnr.230238.p2c2.histones.polII_alternative_promoters.Rdata")

#Saving raw counts from consensus peak set to data frame
cnr.230238.p2c2.histones.polII.raw.count <- lapply(counts.cnr.230238.p2c2.histones.polII[["peaks"]],function(x) x[,6])
cnr.230238.p2c2.histones.polII.raw.count.df<- as.data.frame(cnr.230238.p2c2.histones.polII.raw.count)
rownames(cnr.230238.p2c2.histones.polII.raw.count.df) <- paste0(counts.cnr.230238.p2c2.histones.polII[["peaks"]][[1]][,1], ":", counts.cnr.230238.p2c2.histones.polII[["peaks"]][[1]][,2], "-", counts.cnr.230238.p2c2.histones.polII[["peaks"]][[1]][,3])
colnames(cnr.230238.p2c2.histones.polII.raw.count.df) <- counts.cnr.230238.p2c2.histones.polII$SampleID

#Extracting noramlized counts
counts.cnr.230238.p2c2.histones.polII.norm <- dba.normalize(counts.cnr.230238.p2c2.histones.polII)
counts.cnr.230238.p2c2.histones.polII.norm <- dba.peakset(counts.cnr.230238.p2c2.histones.polII, bRetrieve=TRUE)
counts.cnr.230238.p2c2.histones.polII.norm.df <- as.data.frame(counts.cnr.230238.p2c2.histones.polII.norm)
counts.cnr.230238.p2c2.histones.polII.norm.df$peakID <- paste0(counts.cnr.230238.p2c2.histones.polII.norm.df$seqnames, ":", counts.cnr.230238.p2c2.histones.polII.norm.df$start, "-", counts.cnr.230238.p2c2.histones.polII.norm.df$end)
counts.cnr.230238.p2c2.histones.polII.norm.df.mean <- data.frame(peakID=counts.cnr.230238.p2c2.histones.polII.norm.df$peakID, ATAC_230238=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,6:7]), ATAC_p2c2=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,8:9]),
H3K4me3_230238=counts.cnr.230238.p2c2.histones.polII.norm.df[,10], H3K27ac_230238=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,11:13]), H3K27me3_230238=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,14:15]),
PolII_230238=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,16:17]),
H3K4me3_p2c2=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,18:20]), H3K27ac_p2c2=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,21:23]),
H3K27me3_p2c2=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,24:26]),
PolII_p2c2=rowMeans(counts.cnr.230238.p2c2.histones.polII.norm.df[,27:28]))

write.table(counts.cnr.230238.p2c2.histones.polII.norm.df.mean, "output/data/data_5/rdata/atac_230238_p2c2_alt_promoters_cnr_histone_polII_count.txt", quote = F, sep = "\t", row.names = F, col.names = T)

#Convert to long format
counts.cnr.230238.p2c2.histones.polII.norm.df.mean.long <- rbind(data.frame(peakID=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$peakID, ATAC=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$ATAC_230238, H3K4me3=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K4me3_230238, H3K27ac=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K27ac_230238, H3K27me3=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K27me3_230238, PolII=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$PolII_230238,                   celltype="230238"),data.frame(peakID=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$peakID, ATAC=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$ATAC_p2c2, H3K4me3=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K4me3_p2c2, H3K27ac=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K27ac_p2c2, H3K27me3=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$H3K27me3_p2c2, PolII=counts.cnr.230238.p2c2.histones.polII.norm.df.mean$PolII_p2c2, celltype="P2C2"))



### 
alt.prom.merge.histones.polII <- merge(Tpol2, counts.cnr.230238.p2c2.histones.polII.norm.df.mean.long, by.x="Gene.y", by.y="peakID")



### VIolin

#new
#Histone levels: LIANA annotation
my_comparisons <- list( c("230238", "P2C2"))

ggplot(alt.prom.merge.histones.polII[alt.prom.merge.histones.polII$ebf1=="Ebf1",], aes(celltype,log2(PolII+1), fill=celltype))+
  geom_violin()+ geom_boxplot(width=0.1, outlier.alpha = 0)+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+scale_fill_manual(values=c(rep(c("white","grey"), 6)))+
    facet_grid(Tgene_WT  ~ tss_p2c2)+
  ylim(0,12)+
  stat_compare_means(comparisons = my_comparisons, label.y = c(10.5), label="p.signif")
```


Genes for micke
```{r}
T.pseudo.ex <- T.pseudo[T.pseudo$Tgene_WT != "tgene" & T.pseudo$Tgene_EKO == "tgene" & T.pseudo$ebf1=="Ebf1" & T.pseudo$tss_p2c2!="alt" & T.pseudo$tss_WT=="alt" & T.pseudo$tss_EKO!="alt",]
T.pseudo.ex <- T.pseudo[T.pseudo$Tgene_WT != "tgene" &  T.pseudo$ebf1=="Ebf1" & T.pseudo$tss_p2c2!="alt" & T.pseudo$tss_WT=="alt" ,]
write.table(T.pseudo.ex, "output/data/data_5/examples.txt", quote = F, sep = "\t", row.names = F, col.names = T)

```

## 5.5 Generate tracks files for T element interactions
```{r}
#Use all interaction for P2C2 and use top 100k interactions for WT/EKO. Filter for interactions with T element in any of the anchor points

#P2C2
#Load annotated interaction and filter for T element in any anhor point
int.p2c2.anno <- read.table("output/data/data_3/annotation/atac_230238_p2c2_consensus_peaks_P2C2_H3K4me3_PLAC_annotation/Interaction_annotation/Peak_sepcific_interactions/atac_230238_p2c2_consensus_PLACseq_interactions.txt", header=TRUE, sep="\t")
int.p2c2.anno <- int.p2c2.anno %>% separate_rows(Peak1_ID, sep = ",")  %>% separate_rows(Peak2_ID, sep = ",")
int.p2c2.anno.T <- int.p2c2.anno[int.p2c2.anno$Peak1_ID %in% T_elements_anno_lianaP2C2_distal$peakID | int.p2c2.anno$Peak2_ID %in% T_elements_anno_lianaP2C2_distal$peakID,]

#Prepare long-format
int.p2c2.longrange <- rbind(data.frame(chr=int.p2c2.anno.T$chr1, start=int.p2c2.anno.T$s1, end=int.p2c2.anno.T$e1, loc2=paste0(int.p2c2.anno.T$chr2, ":", int.p2c2.anno.T$s2, "-", int.p2c2.anno.T$e2, ",", -log10(int.p2c2.anno.T$Interaction_score))),data.frame(chr=int.p2c2.anno.T$chr2, start=int.p2c2.anno.T$s2, end=int.p2c2.anno.T$e2, loc2=paste0(int.p2c2.anno.T$chr1, ":", int.p2c2.anno.T$s1, "-", int.p2c2.anno.T$e1, ",", -log10(int.p2c2.anno.T$Interaction_score))))
int.p2c2.longrange <- int.p2c2.longrange[!duplicated(int.p2c2.longrange),]
write.table(int.p2c2.longrange, file = "output/data/data_5/interactions/Telement_interactions_p2c2.bed", quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)


#WT
#Load annotated interaction and filter for T element in any anhor point
int.wt.anno <- read.table("output/data/data_5/annotation/Consensus_atac_WTproB_H3K4me3_PLAC_annotation/Interaction_annotation/Peak_sepcific_interactions/atac_230238_p2c2_consensus_PLACseq_interactions.txt", header=TRUE, sep="\t")
int.wt.anno <- int.wt.anno %>% separate_rows(Peak1_ID, sep = ",")  %>% separate_rows(Peak2_ID, sep = ",")
int.wt.anno.T <- int.wt.anno[int.wt.anno$Peak1_ID %in% T_elements_anno_lianaP2C2_distal$peakID | int.wt.anno$Peak2_ID %in% T_elements_anno_lianaP2C2_distal$peakID,]
int.wt.anno.T <- int.wt.anno.T[int.wt.anno.T$Interaction_score <= 10^-(int.wt.cutoff),]

#Prepare long-format
int.wt.longrange <- rbind(data.frame(chr=int.wt.anno.T$chr1, start=int.wt.anno.T$s1, end=int.wt.anno.T$e1, loc2=paste0(int.wt.anno.T$chr2, ":", int.wt.anno.T$s2, "-", int.wt.anno.T$e2, ",", -log10(int.wt.anno.T$Interaction_score))),data.frame(chr=int.wt.anno.T$chr2, start=int.wt.anno.T$s2, end=int.wt.anno.T$e2, loc2=paste0(int.wt.anno.T$chr1, ":", int.wt.anno.T$s1, "-", int.wt.anno.T$e1, ",", -log10(int.wt.anno.T$Interaction_score))))
int.wt.longrange <- int.wt.longrange[!duplicated(int.wt.longrange),]
write.table(int.wt.longrange, file = "output/data/data_5/interactions/Telement_interactions_WT.bed", quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)

#EKO
#Load annotated interaction and filter for T element in any anhor point
int.eko.anno <- read.table("output/data/data_5/annotation/Consensus_atac_Ebf1KOproB_H3K4me3_PLAC_annotation/Interaction_annotation/Peak_sepcific_interactions/atac_230238_p2c2_consensus_PLACseq_interactions.txt", header=TRUE, sep="\t")
int.eko.anno <- int.eko.anno %>% separate_rows(Peak1_ID, sep = ",")  %>% separate_rows(Peak2_ID, sep = ",")
int.eko.anno.T <- int.eko.anno[int.eko.anno$Peak1_ID %in% T_elements_anno_lianaP2C2_distal$peakID | int.eko.anno$Peak2_ID %in% T_elements_anno_lianaP2C2_distal$peakID,]

#Prepare long-format
int.eko.longrange <- rbind(data.frame(chr=int.eko.anno.T$chr1, start=int.eko.anno.T$s1, end=int.eko.anno.T$e1, loc2=paste0(int.eko.anno.T$chr2, ":", int.eko.anno.T$s2, "-", int.eko.anno.T$e2, ",", -log10(int.eko.anno.T$Interaction_score))),data.frame(chr=int.eko.anno.T$chr2, start=int.eko.anno.T$s2, end=int.eko.anno.T$e2, loc2=paste0(int.eko.anno.T$chr1, ":", int.eko.anno.T$s1, "-", int.eko.anno.T$e1, ",", -log10(int.eko.anno.T$Interaction_score))))
int.eko.longrange <- int.eko.longrange[!duplicated(int.eko.longrange),]
write.table(int.eko.longrange, file = "output/data/data_5/interactions/Telement_interactions_EKO.bed", quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)

```



```{bash engine.opts='-l'}
cd output/data/data_5/interactions/

#p2c2
sort -k1,1 -k2,2n Telement_interactions_p2c2.bed > Telement_interactions_p2c2_s.bed
bgzip Telement_interactions_p2c2_s.bed
tabix -p bed Telement_interactions_p2c2_s.bed.gz

#eko
sort -k1,1 -k2,2n Telement_interactions_EKO.bed > Telement_interactions_EKO_s.bed
bgzip Telement_interactions_EKO_s.bed
tabix -p bed Telement_interactions_EKO_s.bed.gz

#wt
sort -k1,1 -k2,2n Telement_interactions_WT.bed > Telement_interactions_WT_s.bed
bgzip Telement_interactions_WT_s.bed
tabix -p bed Telement_interactions_WT_s.bed.gz

#promoters & pseudopromoters
sort -k1,1 -k2,2n ../annotation/custom_tss_promoters.bed > custom_tss_promoters_s.bed
bgzip custom_tss_promoters_s.bed
tabix -p bed custom_tss_promoters_s.bed.gz

sort -k1,1 -k2,2n ../annotation/custom_tss_pseudopromoters.bed > custom_tss_pseudopromoters_s.bed
bgzip custom_tss_pseudopromoters_s.bed
tabix -p bed custom_tss_pseudopromoters_s.bed.gz

#telements
sort -k1,1 -k2,2n ../T_elements_anno_lianaP2C2_distal.bed > T_elements_anno_lianaP2C2_distal_s.bed
bgzip T_elements_anno_lianaP2C2_distal_s.bed
tabix -p bed T_elements_anno_lianaP2C2_distal_s.bed.gz
```




```{r}
T.pseudo.geney <- T.pseudo[T.pseudo$promoter!="NA",]
T.pseudo.geney <- merge(T.pseudo.geney, custom_tss_anno[,4:7], by.x="Gene.y", by.y="peakID")
T.pseudo.geney <- merge(T.pseudo.geney, rna.norm.WT.EKO.filt[,c(3,10:13)], by.x="Gene.Name", by.y="symbol")

T.pseudo.geney.f <- T.pseudo.geney[T.pseudo.geney$group=="DOWN" & T.pseudo.geney$promoter.y==1 & T.pseudo.geney$tss_p2c2=="NA" & T.pseudo.geney$tss_EKO=="NA" & T.pseudo.geney$Tgene_WT=="NA",]
```








