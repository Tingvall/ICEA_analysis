---
title: "ICE-A: Figure 4 3"
output: html_notebook
---

# 4 Investigation of B/T chromatin interactions

## 4.0 Preperations
Run before:
conda activate liana_analysis_env
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/anaconda3/envs/liana_analysis_env/lib

Setting working directory
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("/mnt/data/common/tobias/tg/ICE_A/ICEA_analysis/"))
```

Loading packages
```{r}
packages <- c("readxl", "AnnotationDbi", "org.Mm.eg.db", "clusterProfiler", "ggplot2", "ggpubr", "circlize", "data.table", "DiffBind", "tidyr", "htmltools")
lapply(packages, library, character.only = TRUE)
```

## 4.1 Prepare interactions

### 4.1.1 Annotate putative elements in B progenitors
Annotate consensus peaks set with EKO/WT PLACseq data. Annotate interaction option for 4.5 (longrange track generation)
```{bash engine.opts='-l'}
script_dir="script/figure4"
bash $script_dir/icea_consensus_230238_p2c2_atac_WT_EKO_annotate_interactions.sh
```

### 4.1.2 Load and filter interactions
```{r}
#Duw to technical issues, numer of interction vary between celltypes. Select top interactions (basde on Q-balue), matching lowser number.
int.p2c2 <-  read.table("data/interactions/P2C2_H3K4me3_FitHiChIP.interactions_FitHiC_Q0.05_MergeNearContacts.bed", header=TRUE, sep="\t")
int.wt <-  read.table("data/interactions/21_174_175_H3K4me3_FLWT_5kb_ALL2ALL.interactions_FitHiC_Q0.05_MergeNearContacts.bed", header=TRUE, sep="\t")
int.eko <-  read.table("data/interactions/13_16_176_177_H3K4me3_FLEKO_5kb_ALL2ALL.interactions_FitHiC_Q0.05_MergeNearContacts.bed", header=TRUE, sep="\t")
nint <- min(nrow(int.p2c2), nrow(int.wt), nrow(int.eko))

int.p2c2 <- int.p2c2[order(int.p2c2$Q.Value_Bias),]
int.p2c2.top <- int.p2c2[1:nint,]
int.p2c2.cutoff <- -log10(max(int.p2c2.top$Q.Value_Bias))

int.wt <- int.wt[order(int.wt$Q.Value_Bias),]
int.wt.top <- int.wt[1:nint,]
int.wt.cutoff <- -log10(max(int.wt.top$Q.Value_Bias))

int.eko <- int.eko[order(int.eko$Q.Value_Bias),]
int.eko.top <- int.eko[1:nint,]
int.eko.cutoff <- -log10(max(int.eko.top$Q.Value_Bias))

#Load annotaiton of consensus peaks
BT_elements_anno_iceaP2C2 <- read.table("output/data/figure2/annotation/atac_230238_p2c2_consensus_peaks_P2C2_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
BT_elements_anno_iceaP2C2$peakID <- paste0(BT_elements_anno_iceaP2C2$Chr, ":", BT_elements_anno_iceaP2C2$Start, "-", BT_elements_anno_iceaP2C2$End)
BT_elements_anno_iceaP2C2$id <- paste0(BT_elements_anno_iceaP2C2$peakID, "_", BT_elements_anno_iceaP2C2$Gene)
BT_elements_anno_iceaP2C2_distal <- BT_elements_anno_iceaP2C2[BT_elements_anno_iceaP2C2$Annotation_method=="Interaction_anno" &BT_elements_anno_iceaP2C2$Peak_type!="Promoter",]
BT_elements_anno_iceaP2C2_distal <- BT_elements_anno_iceaP2C2_distal[BT_elements_anno_iceaP2C2_distal$Interaction_score<max(int.p2c2.top$Q.Value_Bias),]

BT_elements_anno_iceaWT <- read.table("output/data/figure4/annotation/Consensus_atac_WTproB_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
BT_elements_anno_iceaWT$peakID <- paste0(BT_elements_anno_iceaWT$Chr, ":", BT_elements_anno_iceaWT$Start, "-", BT_elements_anno_iceaWT$End)
BT_elements_anno_iceaWT$id <- paste0(BT_elements_anno_iceaWT$peakID, "_", BT_elements_anno_iceaWT$Gene)
BT_elements_anno_iceaWT_distal <- BT_elements_anno_iceaWT[BT_elements_anno_iceaWT$Annotation_method=="Interaction_anno" &BT_elements_anno_iceaWT$Peak_type!="Promoter",]
BT_elements_anno_iceaWT_distal <- BT_elements_anno_iceaWT_distal[BT_elements_anno_iceaWT_distal$Interaction_score<max(int.wt.top$Q.Value_Bias),]

BT_elements_anno_iceaEKO <- read.table("output/data/figure4/annotation/Consensus_atac_Ebf1KOproB_H3K4me3_PLAC_annotation/Peak_annotation/atac_230238_p2c2_consensus/atac_230238_p2c2_consensus_PLACseq_annotated.txt", header=TRUE, sep="\t")
BT_elements_anno_iceaEKO$peakID <- paste0(BT_elements_anno_iceaEKO$Chr, ":", BT_elements_anno_iceaEKO$Start, "-", BT_elements_anno_iceaEKO$End)
BT_elements_anno_iceaEKO$id <- paste0(BT_elements_anno_iceaEKO$peakID, "_", BT_elements_anno_iceaEKO$Gene)
BT_elements_anno_iceaEKO_distal <- BT_elements_anno_iceaEKO[BT_elements_anno_iceaEKO$Annotation_method=="Interaction_anno" &BT_elements_anno_iceaEKO$Peak_type!="Promoter",]
BT_elements_anno_iceaEKO_distal <- BT_elements_anno_iceaEKO_distal[BT_elements_anno_iceaEKO_distal$Interaction_score<max(int.eko.top$Q.Value_Bias),]
```


## 4.2 Annotated to B/T clusters

### 4.2.1 Load clusters and filter
```{r}
#LOad clusters
BT_clusters <-  read.table("output/data/figure2/genelists/BT_gene_clusters.txt", header=TRUE, sep="\t")

#Filter interactions
BT_elements_anno_iceaP2C2_distal.f <- BT_elements_anno_iceaP2C2_distal[,c(17,18,1:3,6,9)]
BT_elements_anno_iceaP2C2_distal.f <- merge(BT_elements_anno_iceaP2C2_distal.f, BT_clusters[,3:4], by.x="Gene", by.y="symbol", all.x=T)
BT_elements_anno_iceaP2C2_distal.f <- unique(BT_elements_anno_iceaP2C2_distal.f)

BT_elements_anno_iceaWT_distal.f <- BT_elements_anno_iceaWT_distal[,c(17,18,1:3,6,9)]
BT_elements_anno_iceaWT_distal.f <- merge(BT_elements_anno_iceaWT_distal.f, BT_clusters[,3:4], by.x="Gene", by.y="symbol",  all.x=T)
BT_elements_anno_iceaP2C2_distal.f <- unique(BT_elements_anno_iceaP2C2_distal.f)

BT_elements_anno_iceaEKO_distal.f <- BT_elements_anno_iceaEKO_distal[,c(17,18,1:3,6,9)]
BT_elements_anno_iceaEKO_distal.f <- merge(BT_elements_anno_iceaEKO_distal.f, BT_clusters[,3:4], by.x="Gene", by.y="symbol",  all.x=T)
BT_elements_anno_iceaEKO_distal.f <- unique(BT_elements_anno_iceaEKO_distal.f)
```

## 4.3 Alternative acitvae promoters
### 4.3.1 Overlap with H3K4me3 in consensus peaks
```{bash engine.opts='-l'}
bash script/general/bedtools_intersect_wa.sh output/data/figure2/peaks/atac_230238_p2c2_idr_consensus_cut.bed data/chip_cnr/peaks/CnR_P2C2_H3K4me3_consensus_peaks.bed output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_P2C2.bed

bash script/general/bedtools_intersect_wa.sh output/data/figure2/peaks/atac_230238_p2c2_idr_consensus_cut.bed data/chip_cnr/peaks/H3K4me3_WT_optimal_set.IDR0.05.narrowPeak output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_WT.bed

bash script/general/bedtools_intersect_wa.sh output/data/figure2/peaks/atac_230238_p2c2_idr_consensus_cut.bed data/chip_cnr/peaks/H3K4me3_Ebf1KO_optimal_set.IDR0.05.narrowPeak output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_Ebf1KO.bed
```


### 4.3.2 Filter for active promoters
```{r}
#Load h3k4me3 elements
consensus_atac_h3k4me3_p2c2 <- read.table("output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_P2C2.bed", header=F, sep="\t")
colnames(consensus_atac_h3k4me3_p2c2) <- c("chr", "start", "end")
consensus_atac_h3k4me3_p2c2$peakID <- paste0(consensus_atac_h3k4me3_p2c2$chr, ":", consensus_atac_h3k4me3_p2c2$start, "-", consensus_atac_h3k4me3_p2c2$end)

consensus_atac_h3k4me3_WT <- read.table("output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_WT.bed", header=F, sep="\t")
colnames(consensus_atac_h3k4me3_WT) <- c("chr", "start", "end")
consensus_atac_h3k4me3_WT$peakID <- paste0(consensus_atac_h3k4me3_WT$chr, ":", consensus_atac_h3k4me3_WT$start, "-", consensus_atac_h3k4me3_WT$end)

consensus_atac_h3k4me3_EKO <- read.table("output/data/figure4/elements/atac_230238_p2c2_idr_consensus_H3K4me3_Ebf1KO.bed", header=F, sep="\t")
colnames(consensus_atac_h3k4me3_EKO) <- c("chr", "start", "end")
consensus_atac_h3k4me3_EKO$peakID <- paste0(consensus_atac_h3k4me3_EKO$chr, ":", consensus_atac_h3k4me3_EKO$start, "-", consensus_atac_h3k4me3_EKO$end)

#Promoter (choose any celltype)
BT_elements_anno_promtoer <-  BT_elements_anno_iceaWT[BT_elements_anno_iceaWT$Peak_type=="Promoter" & BT_elements_anno_iceaWT$Annotation_method=="Proximal_anno",]
BT_elements_anno_promtoer.f <- BT_elements_anno_promtoer[,c(17,18,6,9, 5)]
BT_elements_anno_promtoer.f <- BT_elements_anno_promtoer.f[order(abs(BT_elements_anno_promtoer.f$Distance_to_TSS)),]
BT_elements_anno_promtoer.f <- BT_elements_anno_promtoer.f[!duplicated(BT_elements_anno_promtoer.f$Gene),]
BT_elements_anno_promtoer.f$Ebf1 <- ifelse(BT_elements_anno_promtoer.f$peakID %in% consensus_atac_ebf$peakID, 1, 0)
BT_elements_anno_promtoer.f$H3K4me3_P2C2 <- ifelse(BT_elements_anno_promtoer.f$peakID %in% consensus_atac_h3k4me3_p2c2$peakID, 1,0)
BT_elements_anno_promtoer.f$H3K4me3_WT <- ifelse(BT_elements_anno_promtoer.f$peakID %in% consensus_atac_h3k4me3_WT$peakID, 1,0)
BT_elements_anno_promtoer.f$H3K4me3_EKO <- ifelse(BT_elements_anno_promtoer.f$peakID %in% consensus_atac_h3k4me3_EKO$peakID, 1,0)

#Filter
BT_elements_anno_iceaP2C2_distal.f <- BT_elements_anno_iceaP2C2_distal.f[BT_elements_anno_iceaP2C2_distal.f$Gene %in% BT_elements_anno_promtoer.f[BT_elements_anno_promtoer.f$H3K4me3_P2C2==1,]$Gene,]

BT_elements_anno_iceaWT_distal.f<- BT_elements_anno_iceaWT_distal.f[BT_elements_anno_iceaWT_distal.f$Gene %in% BT_elements_anno_promtoer.f[BT_elements_anno_promtoer.f$H3K4me3_WT==1,]$Gene,]

BT_elements_anno_iceaEKO_distal.f <- BT_elements_anno_iceaEKO_distal.f[BT_elements_anno_iceaEKO_distal.f$Gene %in% BT_elements_anno_promtoer.f[BT_elements_anno_promtoer.f$H3K4me3_EKO==1,]$Gene,]
```



## 4.3 Ebf1 binding
### 4.3.1 Overlap with EBF1 biding in consensus peaks
```{bash engine.opts='-l'}
bash script/general/bedtools_intersect_wa.sh output/data/figure2/peaks/atac_230238_p2c2_idr_consensus_cut.bed data/chip_cnr/peaks/GSE159957_230_238_a_Ebf1_IDR-peaks.bed output/data/figure4/elements/atac_230238_p2c2_idr_consensus_Ebf1_overlap.bed
```

### 4.3.2 Add info about ebf binding
```{r}
#Load Ebf1 elements
consensus_atac_ebf <- read.table("output/data/figure4/elements/atac_230238_p2c2_idr_consensus_Ebf1_overlap.bed", header=F, sep="\t")
colnames(consensus_atac_ebf) <- c("chr", "start", "end")
consensus_atac_ebf$peakID <- paste0(consensus_atac_ebf$chr, ":", consensus_atac_ebf$start, "-", consensus_atac_ebf$end)

#Distal Ebf1 binding
BT_elements_anno_iceaP2C2_distal.f$Ebf1_distal <- ifelse(BT_elements_anno_iceaP2C2_distal.f$peakID %in% consensus_atac_ebf$peakID, 1, 0)
BT_elements_anno_iceaWT_distal.f$Ebf1_distal <- ifelse(BT_elements_anno_iceaWT_distal.f$peakID %in% consensus_atac_ebf$peakID, 1, 0)
BT_elements_anno_iceaEKO_distal.f$Ebf1_distal <- ifelse(BT_elements_anno_iceaEKO_distal.f$peakID %in% consensus_atac_ebf$peakID, 1, 0)

#Promoter
BT_elements_anno_iceaP2C2_distal.f$Ebf1_promoter <- ifelse(BT_elements_anno_iceaP2C2_distal.f$Gene %in% BT_elements_anno_promtoer.f$Gene, 1, 0)
BT_elements_anno_iceaWT_distal.f$Ebf1_promoter <- ifelse(BT_elements_anno_iceaWT_distal.f$Gene %in% BT_elements_anno_promtoer.f$Gene, 1, 0)
BT_elements_anno_iceaEKO_distal.f$Ebf1_promoter <- ifelse(BT_elements_anno_iceaEKO_distal.f$Gene %in% BT_elements_anno_promtoer.f$Gene, 1, 0)
```


## 4.4 Combine data
```{r}
#Organize for merging
BT_elements_anno_iceaP2C2_distal.f$Int_P2C2 <- 1
BT_elements_anno_iceaWT_distal.f$Int_WT <- 1
BT_elements_anno_iceaEKO_distal.f$Int_EKO <- 1

BT_elements_anno_distal.f <- merge(merge(BT_elements_anno_iceaP2C2_distal.f, BT_elements_anno_iceaWT_distal.f, all=T), BT_elements_anno_iceaEKO_distal.f, all=T)
BT_elements_anno_distal.f[is.na(BT_elements_anno_distal.f)] <- 0
BT_elements_anno_distal.f <- BT_elements_anno_distal.f[BT_elements_anno_distal.f$peakID %in% BT_elements_anno_distal.f[BT_elements_anno_distal.f$group!="0",]$peakID,]
BT_elements_anno_distal.f <- unique(BT_elements_anno_distal.f)
```


## 4.4 Circos plot

### 4.4.1 Order input
```{r}
#BT_elements_circos <- BT_elements_anno_distal.f
#BT_elements_circos$Chr <- faczor(gsub("chr","",BT_elements_circos$Chr), levels = c(1:19, "X", "Y")) 
#BT_elements_circos <- BT_elements_circos[order(BT_elements_circos$Chr),]

BT_elements_circos <- BT_elements_anno_distal.f
BT_elements_circos$group <- factor(BT_elements_circos$group,levels=c("T", "PT","0", "PB", "B"))
#BT_elements_circos <- BT_elements_circos[sample(nrow(BT_elements_circos), 1000), ]
#BT_elements_circos.2 <- BT_elements_circos[order(BT_elements_circos$Int_EKO),]

BT_elements_circos.agg <-  BT_elements_circos %>% 
  group_by(Gene) %>% 
  summarise(across(c(Int_P2C2, Int_WT, Int_EKO), list(sum = sum)))
BT_elements_circos.agg$order <- ifelse(BT_elements_circos.agg$Int_P2C2_sum==0 & BT_elements_circos.agg$Int_WT_sum!=0, -1, ifelse(BT_elements_circos.agg$Int_WT_sum==0 & BT_elements_circos.agg$Int_P2C2_sum!=1, 1, 0))

BT_elements_circos <- merge(BT_elements_circos, BT_elements_circos.agg, by="Gene")
BT_elements_circos <- BT_elements_circos[order(BT_elements_circos$order),]

#BT_elements_circos <- BT_elements_circos[order(-BT_elements_circos$Int_WT,BT_elements_circos$Int_P2C2, BT_elements_circos$Int_EKO),]
#BT_elements_circos <- BT_elements_circos[order(BT_elements_circos$group),]
```


### 4.4.2 Plot
Find links
```{r}
#Oranize for circos
circos.elements <- data.frame(section="Elements", name=unique(BT_elements_circos[order(BT_elements_circos$Chr, BT_elements_circos$Start),]$peakID))
#circos.elements <- data.frame(section="Elements", name=unique(BT_elements_circos.2$peakID))
#circos.elements <- circos.elements[rev(rownames(circos.elements)),]
circos.T <- data.frame(section="T", name=unique(BT_elements_circos[BT_elements_circos$group=="T",]$Gene))
circos.PT <- data.frame(section="PT", name=unique(BT_elements_circos[BT_elements_circos$group=="PT",]$Gene))
circos.PB <- data.frame(section="PB", name=unique(BT_elements_circos[BT_elements_circos$group=="PB",]$Gene))
circos.B <- data.frame(section="B", name=unique(BT_elements_circos[BT_elements_circos$group=="B",]$Gene))
circos.0 <- data.frame(section="0", name=unique(BT_elements_circos[BT_elements_circos$group=="0",]$Gene))

circos.BT <- rbind(circos.elements, circos.T, circos.PT, circos.PB, circos.B, circos.0)
circos.BT$x <- 1:nrow(circos.BT)
circos.BT$section <- factor(circos.BT$section, levels=c("Elements", "T", "PT","0", "PB", "B"))

#Scaling
circos.BT$x <- ifelse(!circos.BT$section %in% c("Elements", "0"), circos.BT$x*5,circos.BT$x)

#color
cols <-c("#59595b", "#1f426a", "#6da148", "#59595b","#d37f28","#632a54")

#p2c2
links.p2c2 <- na.omit(rbind(data.frame(from=BT_elements_circos[BT_elements_circos$Int_P2C2==1 & BT_elements_circos$group=="T",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_P2C2==1 &BT_elements_circos$group=="T",]$Gene, section="T"), data.frame(from=BT_elements_circos[BT_elements_circos$Int_P2C2==1 & BT_elements_circos$group=="PT",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_P2C2==1 &BT_elements_circos$group=="PT",]$Gene, section="PT"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_P2C2==1 & BT_elements_circos$group=="PB",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_P2C2==1 &BT_elements_circos$group=="PB",]$Gene, section="PB"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_P2C2==1 & BT_elements_circos$group=="B",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_P2C2==1 &BT_elements_circos$group=="B",]$Gene, section="B"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_P2C2==1 & BT_elements_circos$group=="0",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_P2C2==1 &BT_elements_circos$group=="0",]$Gene, section="0")))
links.p2c2 <- merge(links.p2c2, circos.BT[,2:3], by.x="from", by.y="name")
links.p2c2 <- merge(links.p2c2, circos.BT[,2:3], by.x="to", by.y="name")
links.p2c2 <- links.p2c2[,c(2,1,3,4,5)]
colnames(links.p2c2) <- c("from", "to", "section","x1", "x2")
links.p2c2 <- links.p2c2[!duplicated(links.p2c2),]
links.p2c2$col <- ifelse(links.p2c2$section=="T", cols[2], ifelse(links.p2c2$section=="PT", cols[3], ifelse(links.p2c2$section=="PB", cols[5], ifelse(links.p2c2$section=="B", cols[6], cols[4]))))
#links.p2c2$col <- ifelse(links.p2c2$from %in% BT_elements_circos[BT_elements_circos$Ebf1_distal==1,]$peakID, "red", "grey")
links.p2c2$section <- factor(links.p2c2$section, levels=c("0", "PT", "PB", "T", "B"))
links.p2c2 <- links.p2c2[order(links.p2c2$section),]

#WT
links.WT <- na.omit(rbind(data.frame(from=BT_elements_circos[BT_elements_circos$Int_WT==1 & BT_elements_circos$group=="T",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_WT==1 &BT_elements_circos$group=="T",]$Gene, section="T"), data.frame(from=BT_elements_circos[BT_elements_circos$Int_WT==1 & BT_elements_circos$group=="PT",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_WT==1 &BT_elements_circos$group=="PT",]$Gene, section="PT"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_WT==1 & BT_elements_circos$group=="PB",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_WT==1 &BT_elements_circos$group=="PB",]$Gene, section="PB"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_WT==1 & BT_elements_circos$group=="B",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_WT==1 &BT_elements_circos$group=="B",]$Gene, section="B"), data.frame(from=BT_elements_circos[BT_elements_circos$Int_WT==1 & BT_elements_circos$group=="0",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_WT==1 &BT_elements_circos$group=="0",]$Gene, section="0")))
links.WT <- merge(links.WT, circos.BT[,2:3], by.x="from", by.y="name")
links.WT <- merge(links.WT, circos.BT[,2:3], by.x="to", by.y="name")
links.WT <- links.WT[,c(2,1,3,4,5)]
colnames(links.WT) <- c("from", "to", "section","x1", "x2")
links.WT <- links.WT[!duplicated(links.WT),]
links.WT$col <- ifelse(links.WT$section=="T", cols[2], ifelse(links.WT$section=="PT", cols[3], ifelse(links.WT$section=="PB", cols[5], ifelse(links.WT$section=="B", cols[6], cols[4]))))
#links.WT$col <- ifelse(links.WT$from %in% BT_elements_circos[BT_elements_circos$Ebf1_distal==1,]$peakID, "red", "grey")
links.WT$section <- factor(links.WT$section, levels=c("0", "PT", "PB", "T", "B"))
links.WT <- links.WT[order(links.WT$section),]

#EKO
links.EKO <- na.omit(rbind(data.frame(from=BT_elements_circos[BT_elements_circos$Int_EKO==1 & BT_elements_circos$group=="T",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_EKO==1 &BT_elements_circos$group=="T",]$Gene, section="T"), data.frame(from=BT_elements_circos[BT_elements_circos$Int_EKO==1 & BT_elements_circos$group=="PT",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_EKO==1 &BT_elements_circos$group=="PT",]$Gene, section="PT"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_EKO==1 & BT_elements_circos$group=="PB",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_EKO==1 &BT_elements_circos$group=="PB",]$Gene, section="PB"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_EKO==1 & BT_elements_circos$group=="B",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_EKO==1 &BT_elements_circos$group=="B",]$Gene, section="B"),data.frame(from=BT_elements_circos[BT_elements_circos$Int_EKO==1 & BT_elements_circos$group=="0",]$peakID, to=BT_elements_circos[BT_elements_circos$Int_EKO==1 &BT_elements_circos$group=="0",]$Gene, section="0")))
links.EKO <- merge(links.EKO, circos.BT[,2:3], by.x="from", by.y="name")
links.EKO <- merge(links.EKO, circos.BT[,2:3], by.x="to", by.y="name")
links.EKO <- links.EKO[,c(2,1,3,4,5)]
colnames(links.EKO) <- c("from", "to", "section","x1", "x2")
links.EKO <- links.EKO[!duplicated(links.EKO),]
links.EKO$col <- ifelse(links.EKO$section=="T", cols[2], ifelse(links.EKO$section=="PT", cols[3], ifelse(links.EKO$section=="PB", cols[5], ifelse(links.EKO$section=="B", cols[6], cols[4]))))
#links.EKO$col <- ifelse(links.EKO$from %in% BT_elements_circos[BT_elements_circos$Ebf1_distal==1,]$peakID, "red", "grey")
links.EKO$section <- factor(links.EKO$section, levels=c("0", "PT", "PB", "T", "B"))
links.EKO <- links.EKO[order(links.EKO$section),]

```


Plot
```{R}

##plot
circos.sum.BT <- aggregate(circos.BT$x, list(circos.BT$section), FUN=mean) 
circos.sum.BT$x.adj <- max(circos.sum.BT$x)-circos.sum.BT$x+max(circos.BT$x)/360*30

#cairo_pdf("output/plots/figure4/BTgene_alternative_promoters_circos.pdf", width = 12, height=6)
layout(matrix(1:3, 1, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))

#p2c2
circos.clear()
circos.par("track.height" = 0.1, "clock.wise"=F, start.degree=15, gap.degree=c(30, 5,5,5,5,30))
circos.initialize(circos.BT$section, x = circos.BT$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.p2c2)){
  circos.link("Elements", links.p2c2[i,"x1"], links.p2c2[i,"section"], links.p2c2[i,"x2"], lwd=0.2,col = links.p2c2[i,"col"])
}

#Wt
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=15, gap.degree=c(30, 5,5,5,5,30))
circos.initialize(circos.BT$section, x = circos.BT$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.WT)){
  circos.link("Elements", links.WT[i,"x1"], links.WT[i,"section"], links.WT[i,"x2"], lwd=0.2,  col = links.WT[i,"col"])
}

#Ebf1KO
circos.clear()
circos.par("track.height" = 0.1,"clock.wise"=F, start.degree=15, gap.degree=c(30, 5,5,5,5,30))
circos.initialize(circos.BT$section, x = circos.BT$x)
circos.track(ylim=c(0,1), bg.col = cols)
for (i in 1:nrow(links.EKO)){
  circos.link("Elements", links.EKO[i,"x1"], links.EKO[i,"section"], links.EKO[i,"x2"], lwd=0.2, col = links.EKO[i,"col"])
}
#dev.off()
```

### 4.4.3 Stats
```{R}
# Number of interactions
length(links.p2c2[links.p2c2$section=="T",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="T",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="T",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="PT",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="PT",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="PT",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="0",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="0",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="0",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="PB",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="PB",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="PB",]$from)#/length(unique(links.p2c2$from))*100

length(links.p2c2[links.p2c2$section=="B",]$from)#/length(unique(links.p2c2$from))*100
length(links.WT[links.WT$section=="B",]$from)#/length(unique(links.p2c2$from))*100
length(links.EKO[links.EKO$section=="B",]$from)#/length(unique(links.p2c2$from))*100

#Alt prom
#T
T_alt <- BT_elements_circos[BT_elements_circos$peakID %in% BT_elements_circos[BT_elements_circos$group=="B" & BT_elements_circos$Int_WT==1,]$peakID,]
T_alt.p2c2 <- T_alt[T_alt$Int_P2C2==1,]
T_alt.WT <- T_alt[T_alt$Int_WT==1,]
T_alt.EKO <- T_alt[T_alt$Int_EKO==1,]


length(unique(T_alt.p2c2[T_alt.p2c2$peakID %in% T_alt.p2c2[T_alt.p2c2$group!="B",]$peakID & T_alt.p2c2$group=="B",]$peakID))/length(unique(T_alt$peakID))*100
length(unique(T_alt.p2c2[!T_alt.p2c2$peakID %in% T_alt.p2c2[T_alt.p2c2$group=="B",]$peakID,]$peakID))/length(unique(T_alt$peakID))*100

length(unique(T_alt.WT[T_alt.WT$peakID %in% T_alt.WT[T_alt.WT$group!="B",]$peakID & T_alt.WT$group=="B",]$peakID))/length(unique(T_alt$peakID))*100
length(unique(T_alt.WT[!T_alt.WT$peakID %in% T_alt.WT[T_alt.WT$group=="B",]$peakID,]$peakID))/length(unique(T_alt$peakID))*100

length(unique(T_alt.EKO[T_alt.EKO$peakID %in% T_alt.EKO[T_alt.EKO$group!="B",]$peakID & T_alt.EKO$group=="B",]$peakID))/length(unique(T_alt$peakID))*100
length(unique(T_alt.EKO[!T_alt.EKO$peakID %in% T_alt.EKO[T_alt.EKO$group=="B",]$peakID,]$peakID))/length(unique(T_alt$peakID))*100
```


```{r}
B.genes.wt <- unique(BT_elements_circos[BT_elements_circos$Int_EKO==0 & BT_elements_circos$Int_WT==1, ]$Gene)
alt.genes.eko <- unique(BT_elements_circos[BT_elements_circos$Int_WT==0 & BT_elements_circos$Int_EKO==1, ]$Gene)

B.genes.wt.f <- B.genes.wt[!B.genes.wt %in% alt.genes.eko]
alt.genes.eko.f <- alt.genes.eko[!alt.genes.eko %in% B.genes.wt]

test <- rbind(data.frame(gene=B.genes.wt.f, cat="wt"),data.frame(gene=alt.genes.eko.f, cat="eko"))
test <- merge(test, rna.norm.WT.EKO[,c(3,10:12)], by.x="gene", by.y="symbol")
test <- test[!duplicated(test),]
test.wide <- gather(test, celltype, value, WT_mean:EKO_mean, factor_key=TRUE)
test.wide$celltype <- factor(test.wide$celltype, levels=c("EKO_mean", "WT_mean"))

summary(test[test$cat=="wt",]$log2FC)
summary(test[test$cat=="eko",]$log2FC)

#plot
source("script/general/r_functions/TG_theme.R")
my_comparisons <- list( c("WT_mean", "EKO_mean"))
plot.Tgenes.alt <- ggplot(test.wide, aes(celltype, log2(value+1)))+
  geom_violin()+ geom_boxplot(width=0.1, outlier.alpha = 0)+
  theme_bw() +
   facet_grid(.  ~ cat)+
  ylim(0,17)+
  TG_theme()+
stat_compare_means(comparisons = my_comparisons, label="p.signif", label.y = c(14))



```

